<!DOCTYPE html>  <html> <head>   <title>Game.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Animator.html">                 Animator.coffee               </a>                                           <a class="source" href="Block.html">                 Block.coffee               </a>                                           <a class="source" href="Compressor.html">                 Compressor.coffee               </a>                                           <a class="source" href="Constants.html">                 Constants.coffee               </a>                                           <a class="source" href="EventEmitter.html">                 EventEmitter.coffee               </a>                                           <a class="source" href="Game.html">                 Game.coffee               </a>                                           <a class="source" href="HitTestLayer.html">                 HitTestLayer.coffee               </a>                                           <a class="source" href="Layer.html">                 Layer.coffee               </a>                                           <a class="source" href="Main.html">                 Main.coffee               </a>                                           <a class="source" href="Map.html">                 Map.coffee               </a>                                           <a class="source" href="MapLayer.html">                 MapLayer.coffee               </a>                                           <a class="source" href="Marble.html">                 Marble.coffee               </a>                                           <a class="source" href="Palette.html">                 Palette.coffee               </a>                                           <a class="source" href="Path.html">                 Path.coffee               </a>                                           <a class="source" href="Renderer.html">                 Renderer.coffee               </a>                                           <a class="source" href="TextureStore.html">                 TextureStore.coffee               </a>                                           <a class="source" href="VisibilityLayer.html">                 VisibilityLayer.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Game.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>This class handles the game logic, it defines the event handlers and
controls the rendering process.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Game</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Creates a new game using the given settings, then calls the onload
callback.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(onload) -&gt;</span>
    <span class="vi">@map = </span><span class="k">new</span> <span class="nx">Map</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">mapSize</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">state</span> <span class="o">?=</span> <span class="p">{}</span>
    <span class="nv">state.type = </span><span class="s1">&#39;normal&#39;</span>

    <span class="vi">@marbleRunning = </span><span class="kc">no</span>

    <span class="vi">@mainCanvas    = </span><span class="nx">$</span><span class="p">(</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">mainCanvasID</span><span class="p">)</span>
    <span class="vi">@draggedCanvas = </span><span class="nx">$</span><span class="p">(</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">draggedCanvasID</span><span class="p">)</span>
    <span class="vi">@selector      = </span><span class="nx">$</span><span class="p">(</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">selectorID</span><span class="p">)</span>

    <span class="vi">@marble   = </span><span class="k">new</span> <span class="nx">Marble</span>
    <span class="vi">@animator = </span><span class="k">new</span> <span class="nx">Animator</span> <span class="nx">@map</span><span class="p">,</span> <span class="nx">@marble</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set up the renderer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@renderer = </span><span class="k">new</span> <span class="nx">Renderer</span> <span class="nx">@animator</span><span class="p">,</span> <span class="nx">@map</span><span class="p">,</span> <span class="nx">@marble</span><span class="p">,</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Set up event handlers</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">bind</span>    <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span>   <span class="nx">@canvasUp</span>
      <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">bind</span>  <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">@canvasMove</span>
      <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">bind</span>  <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">@canvasDown</span>

      <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">bind</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">@normalizeCoordinates</span><span class="p">(</span><span class="nx">@canvasDown</span><span class="p">)</span>
      <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">bind</span>  <span class="s1">&#39;touchmove&#39;</span><span class="p">,</span> <span class="nx">@normalizeCoordinates</span><span class="p">(</span><span class="nx">@canvasMove</span><span class="p">)</span>
      <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">bind</span>   <span class="s1">&#39;touchend&#39;</span><span class="p">,</span> <span class="nx">@normalizeCoordinates</span><span class="p">(</span>  <span class="nx">@canvasUp</span><span class="p">)</span>

      <span class="nv">$body = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)</span>

      <span class="nx">$body</span><span class="p">.</span><span class="nx">bind</span>   <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span>   <span class="nx">@bodyUp</span>
      <span class="nx">$body</span><span class="p">.</span><span class="nx">bind</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">@bodyMove</span>
      <span class="nx">$body</span><span class="p">.</span><span class="nx">bind</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">@bodyDown</span>

      <span class="nx">$body</span><span class="p">.</span><span class="nx">bind</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">@normalizeCoordinates</span><span class="p">(</span><span class="nx">@bodyDown</span><span class="p">)</span>
      <span class="nx">$body</span><span class="p">.</span><span class="nx">bind</span>  <span class="s1">&#39;touchmove&#39;</span><span class="p">,</span> <span class="nx">@normalizeCoordinates</span><span class="p">(</span><span class="nx">@bodyMove</span><span class="p">)</span>
      <span class="nx">$body</span><span class="p">.</span><span class="nx">bind</span>   <span class="s1">&#39;touchend&#39;</span><span class="p">,</span> <span class="nx">@normalizeCoordinates</span><span class="p">(</span>  <span class="nx">@bodyUp</span><span class="p">)</span>

      <span class="nv">rotateEverything = </span><span class="p">(</span><span class="nx">clockwise</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@selectBlock</span> <span class="kc">null</span>
          <span class="nx">@hideSelector</span><span class="p">()</span>
          
          <span class="k">if</span> <span class="nx">clockwise</span>
            <span class="nx">@map</span><span class="p">.</span><span class="nx">rotateCW</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nx">@map</span><span class="p">.</span><span class="nx">rotateCCW</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Bind event handlers to the rotation arrows</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#game .left&#39;</span><span class="p">).</span><span class="nx">bind</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">rotateEverything</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#game .right&#39;</span><span class="p">).</span><span class="nx">bind</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">rotateEverything</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

      <span class="nv">selectorRotate = </span><span class="p">(</span><span class="nx">clockwise</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">coordinates</span>
          <span class="nv">block      = </span><span class="nx">@map</span><span class="p">.</span><span class="nx">getBlock</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span>
          <span class="nv">blockOnTop = </span><span class="nx">@map</span><span class="p">.</span><span class="nx">getBlock</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">z</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Do not rotate the lowest layer of the block</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">block</span><span class="p">.</span><span class="nx">rotate</span>      <span class="nx">clockwise</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span> <span class="kc">yes</span><span class="p">,</span>  <span class="kc">no</span>
          <span class="nx">blockOnTop</span><span class="p">.</span><span class="nx">rotate</span> <span class="nx">clockwise</span><span class="p">,</span>  <span class="kc">no</span><span class="p">,</span>  <span class="kc">no</span><span class="p">,</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">blockOnTop</span>

          <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
          <span class="k">return</span> <span class="kc">off</span>

      <span class="nx">@selector</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s1">&#39;.left&#39;</span><span class="p">).</span><span class="nx">bind</span>  <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">selectorRotate</span>  <span class="kc">no</span>
      <span class="nx">@selector</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s1">&#39;.right&#39;</span><span class="p">).</span><span class="nx">bind</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">selectorRotate</span> <span class="kc">yes</span>

      <span class="nx">@map</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;didChange&#39;</span><span class="p">,</span> <span class="nx">@updateButton</span>

      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.run&#39;</span><span class="p">).</span><span class="nx">bind</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">@prepareRun</span>

      <span class="vi">@palette = </span><span class="k">new</span> <span class="nx">Palette</span> <span class="nx">@renderer</span><span class="p">,</span> <span class="nx">@startDragWithBlocks</span>

      <span class="nv">animatorLoop = </span><span class="o">=&gt;</span>
        <span class="nx">@animator</span><span class="p">.</span><span class="nx">animate</span><span class="p">()</span>
        <span class="nx">setTimeout</span> <span class="nx">animatorLoop</span><span class="p">,</span> <span class="mi">20</span>

      <span class="nx">setTimeout</span> <span class="nx">animatorLoop</span><span class="p">,</span> <span class="mi">20</span>

      <span class="nx">onload</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Selects a given block.
The selected block will be rendered semi-transparently.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">selectBlock: </span><span class="nf">(block) -&gt;</span>
    <span class="nx">@selectedBlock</span><span class="p">.</span><span class="nx">setSelected</span> <span class="kc">no</span>  <span class="k">if</span> <span class="nx">@selectedBlock</span>
    <span class="vi">@selectedBlock = </span><span class="nx">block</span> 
    <span class="nx">@selectedBlock</span><span class="p">.</span><span class="nx">setSelected</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">@selectedBlock</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Display the selector overlay at the given screen coordinates.
It provides means to rotate the currently selected block.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">displaySelector: </span><span class="nf">(x = 0, y = 0) -&gt;</span>
    <span class="nx">@selector</span><span class="p">.</span><span class="nx">css</span>
      <span class="s1">&#39;display&#39;</span><span class="o">:</span> <span class="s1">&#39;block&#39;</span>
      <span class="s1">&#39;position&#39;</span><span class="o">:</span> <span class="s1">&#39;absolute&#39;</span>
      <span class="s1">&#39;top&#39;</span><span class="o">:</span>  <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>  <span class="o">+</span> <span class="nx">y</span>
      <span class="s1">&#39;left&#39;</span><span class="o">:</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Hides the selector overlay.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hideSelector: </span><span class="o">-&gt;</span>
    <span class="nx">@selector</span><span class="p">.</span><span class="nx">css</span>
      <span class="s1">&#39;display&#39;</span><span class="o">:</span> <span class="s1">&#39;none&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Default mouseDown event handler for events outside the main canvas.</p>

<p>If the user mouse-downs anywhere without being in a drag operation,
deselect the current block (if it exists).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bodyDown: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">when</span> <span class="s1">&#39;normal&#39;</span>
        <span class="nx">@selectBlock</span> <span class="kc">null</span>
        <span class="nx">@hideSelector</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Default mouseMove event handler for events outside the main canvas.</p>

<p>As we are drawing the currently dragged block on an indepented canvas
under the current mouse position, mouse movements during a dragging operation
will not be caught by the canvas.
Therefore we have to handle the dragging at this position.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bodyMove: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">when</span> <span class="s1">&#39;dragging&#39;</span>
        <span class="nx">@draggingMove</span> <span class="nx">event</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Default mouseUp event handler for events outside the main canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bodyUp: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">when</span> <span class="s1">&#39;dragging&#39;</span>
        <span class="nx">@draggingUp</span> <span class="nx">event</span>

    <span class="k">return</span> <span class="kc">off</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Default event handler for mouseUp events inside the main canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canvasUp: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If the user is dragging, end the current dragging operation</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;dragging&#39;</span>
        <span class="nx">@draggingUp</span> <span class="nx">event</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Select the current block if this is the same block the user previously
mouseDowned on.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;down&#39;</span>
        <span class="nv">mouseX = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span>
        <span class="nv">mouseY = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
        <span class="k">if</span> <span class="nx">state</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">block</span> <span class="o">is</span> <span class="nx">@renderer</span><span class="p">.</span><span class="nx">resolveScreenCoordinates</span><span class="p">(</span><span class="nx">mouseX</span><span class="p">,</span> <span class="nx">mouseY</span><span class="p">).</span><span class="nx">block</span>
          <span class="nx">@selectBlock</span> <span class="nx">state</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">block</span>
          <span class="p">[</span><span class="nx">screenX</span><span class="p">,</span> <span class="nx">screenY</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderer</span><span class="p">.</span><span class="nx">renderingCoordinatesForBlock</span> <span class="nx">state</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">block</span>
          <span class="nx">@displaySelector</span> <span class="nx">screenX</span><span class="p">,</span> <span class="nx">screenY</span>
          <span class="nv">state.type = </span><span class="s1">&#39;normal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Deselect the currently selected blocks if it exists and the user releases
the mouse outside of a block.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">when</span> <span class="s1">&#39;normal&#39;</span>
        <span class="nx">@selectBlock</span> <span class="kc">null</span>
        <span class="nx">@hideSelector</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Illegal state&quot;</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span> <span class="k">if</span> <span class="nx">DEBUG</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Stop from bubbling</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="kc">off</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Default event handler for mouseMove events inside the main canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canvasMove: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">mouseX = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span>
    <span class="nv">mouseY = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">when</span> <span class="s1">&#39;down&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>If the user moves more than <code>Settings.draggingOffset</code> pixels
from where the put the mouse down, start a drag operation</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">downX</span> <span class="o">-</span> <span class="nx">mouseX</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">draggingOffset</span> <span class="o">or</span>
           <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">downY</span> <span class="o">-</span> <span class="nx">mouseY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">draggingOffset</span>
          <span class="nx">@startDrag</span> <span class="nx">event</span>
      <span class="k">when</span> <span class="s1">&#39;dragging&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>This catches events if the dragged blocks are rendered in the main
canvas or if the mouse moved faster than we could position the
dragged blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@draggingMove</span> <span class="nx">event</span>
      <span class="k">when</span> <span class="s1">&#39;normal&#39;</span>
        <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span> <span class="o">isnt</span> <span class="s1">&#39;touchmove&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set cursor dependent on contents at mouse position.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">side = </span><span class="nx">@renderer</span><span class="p">.</span><span class="nx">sideAtScreenCoordinates</span><span class="p">(</span><span class="nx">mouseX</span><span class="p">,</span> <span class="nx">mouseY</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">side</span> <span class="o">and</span> <span class="nx">side</span> <span class="o">isnt</span> <span class="s1">&#39;floor&#39;</span>
            <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;cursor&#39;</span><span class="p">,</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">dragCursor</span>
          <span class="k">else</span>
            <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;cursor&#39;</span><span class="p">,</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">defaultCursor</span>

    <span class="k">if</span> <span class="nx">@renderer</span><span class="p">.</span><span class="nx">sideAtScreenCoordinates</span><span class="p">(</span><span class="nx">mouseX</span><span class="p">,</span> <span class="nx">mouseY</span><span class="p">)</span> <span class="o">isnt</span> <span class="kc">null</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Default event handler for mouseDown events inside the main canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canvasDown: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">type</span>
      <span class="k">when</span> <span class="s1">&#39;normal&#39;</span>
        <span class="nv">mouseX = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span>
        <span class="nv">mouseY = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
        <span class="nv">info = </span><span class="nx">@renderer</span><span class="p">.</span><span class="nx">resolveScreenCoordinates</span> <span class="nx">mouseX</span><span class="p">,</span> <span class="nx">mouseY</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>If the user mouse-downed on a block, save the location and block
to detect drag or selection operations.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">block</span>
          <span class="nv">state.type  = </span><span class="s1">&#39;down&#39;</span>
          <span class="nv">state.downX = </span><span class="nx">mouseX</span>
          <span class="nv">state.downY = </span><span class="nx">mouseY</span>
          <span class="nv">state.info  = </span><span class="nx">info</span>
          <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">on</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>This method handles the process of dragging operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draggingMove: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Removing all dragged blocks as they may be drawn elsewhere
FIXME: This is only necessary if the position or state of the dragged
       blocks actually changed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">didRemoveBlocks = </span><span class="kc">no</span>
    <span class="nx">@map</span><span class="p">.</span><span class="nx">blocksEach</span> <span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">block</span><span class="p">.</span><span class="nx">dragged</span>
        <span class="nx">@map</span><span class="p">.</span><span class="nx">removeBlock</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...,</span> <span class="kc">yes</span>
        <span class="nv">didRemoveBlocks = </span><span class="kc">yes</span>

    <span class="nv">mouseX = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span>
    <span class="nv">mouseY = </span><span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
    <span class="nv">info = </span><span class="nx">@renderer</span><span class="p">.</span><span class="nx">resolveScreenCoordinates</span> <span class="nx">mouseX</span><span class="p">,</span> <span class="nx">mouseY</span>

    <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span>   <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">coordinates</span> <span class="o">||</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">#XXX</span>
    <span class="nv">targetBlock = </span><span class="nx">@map</span><span class="p">.</span><span class="nx">getBlock</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span>
    <span class="nv">lowestBlock = </span><span class="nx">state</span><span class="p">.</span><span class="nx">stack</span> <span class="o">&amp;&amp;</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;cursor&#39;</span><span class="p">,</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">draggingCursor</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>If the user moved the blocks onto the floor or onto the top of another block,
stack them there.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">side</span> <span class="o">is</span> <span class="s1">&#39;floor&#39;</span> <span class="o">or</span>
       <span class="nx">info</span><span class="p">.</span><span class="nx">side</span> <span class="o">is</span> <span class="s1">&#39;top&#39;</span>   <span class="o">and</span>
       <span class="nx">@map</span><span class="p">.</span><span class="nx">heightAt</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">+</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">and</span>
       <span class="nx">Block</span><span class="p">.</span><span class="nx">canStack</span> <span class="nx">targetBlock</span><span class="p">,</span> <span class="nx">lowestBlock</span>
      <span class="nx">@hideDraggedCanvas</span> <span class="nx">event</span>

      <span class="k">if</span> <span class="nx">lowestBlock</span>
        <span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">side</span> <span class="o">is</span> <span class="s1">&#39;top&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Set the low type and rotation of the lowest block to whatever the
target block has on top</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">]</span> <span class="o">=</span> <span class="nx">targetBlock</span><span class="p">.</span><span class="nx">getProperty</span> <span class="s1">&#39;top&#39;</span>

          <span class="nv">type = </span><span class="p">(</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;crossing-hole&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;crossing&#39;</span> <span class="o">||</span> <span class="nx">type</span>

          <span class="nx">lowestBlock</span><span class="p">.</span><span class="nx">setProperty</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">,</span> <span class="kc">yes</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Set the low type of the to nothing</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">lowestBlock</span><span class="p">.</span><span class="nx">setProperty</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">yes</span>

      <span class="nv">offset = </span><span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">side</span> <span class="o">is</span> <span class="s1">&#39;top&#39;</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
      <span class="nx">@map</span><span class="p">.</span><span class="nx">setStack</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span> <span class="o">+</span> <span class="nx">offset</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>otherwise, display the dragged canvas and move it to the mouse position</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span>
      <span class="nx">@map</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">()</span> <span class="k">if</span> <span class="nx">didRemoveBlocks</span>
      <span class="nx">@showDraggedCanvas</span> <span class="nx">event</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Starts a drag operation using with a given event.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">startDrag: </span><span class="nf">(event) -&gt;</span>
    <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">coordinates</span>
    <span class="nv">blocks = </span><span class="nx">@map</span><span class="p">.</span><span class="nx">removeStack</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)</span>

    <span class="p">[</span><span class="nx">canvasX</span><span class="p">,</span> <span class="nx">canvasY</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderer</span><span class="p">.</span><span class="nx">renderingCoordinatesForBlock</span> <span class="nx">blocks</span><span class="p">[</span><span class="nx">blocks</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="nv">info =</span>
      <span class="nv">mouseOffsetX: </span><span class="nx">state</span><span class="p">.</span><span class="nx">downX</span> <span class="o">-</span> <span class="nx">canvasX</span>
      <span class="nv">mouseOffsetY: </span><span class="nx">state</span><span class="p">.</span><span class="nx">downY</span> <span class="o">-</span> <span class="nx">canvasY</span><span class="c1"># - Settings.textureSizeHalf</span>

    <span class="nx">@startDragWithBlocks</span> <span class="nx">blocks</span><span class="p">,</span> <span class="nx">info</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Starts a drag operation using a given stack of blocks.
Info must contain the mouse offsets relative to the block.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">startDragWithBlocks: </span><span class="p">(</span><span class="nx">blocks</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">@selectBlock</span> <span class="kc">null</span>
    <span class="nx">@hideSelector</span><span class="p">()</span>
    <span class="nv">state.stack = </span><span class="nx">blocks</span>
    <span class="k">for</span> <span class="nx">block</span> <span class="k">in</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stack</span>
      <span class="nx">block</span><span class="p">.</span><span class="nx">setDragged</span> <span class="kc">yes</span>

    <span class="nx">@renderer</span><span class="p">.</span><span class="nx">drawDraggedBlocks</span> <span class="nx">state</span><span class="p">.</span><span class="nx">stack</span>

    <span class="nv">state.mouseOffsetX = </span><span class="nx">info</span><span class="p">.</span><span class="nx">mouseOffsetX</span>
    <span class="nv">state.mouseOffsetY = </span><span class="nx">info</span><span class="p">.</span><span class="nx">mouseOffsetY</span>
    <span class="nv">state.type = </span><span class="s1">&#39;dragging&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Hides the dragged blocks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hideDraggedCanvas: </span><span class="nf">(event) -&gt;</span>
    <span class="nx">@draggedCanvas</span><span class="p">.</span><span class="nx">css</span> <span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Shows the dragged blocks and moves them to the mouse posiiton.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">showDraggedCanvas: </span><span class="nf">(event) -&gt;</span>
    <span class="nv">style =</span>
      <span class="s1">&#39;display&#39;</span><span class="o">:</span> <span class="s1">&#39;block&#39;</span>
      <span class="s1">&#39;position&#39;</span><span class="o">:</span> <span class="s1">&#39;absolute&#39;</span>
      <span class="s1">&#39;top&#39;</span><span class="o">:</span>  <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">mouseOffsetY</span>
      <span class="s1">&#39;left&#39;</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">state</span><span class="p">.</span><span class="nx">mouseOffsetX</span>
    <span class="nx">@draggedCanvas</span><span class="p">.</span><span class="nx">css</span> <span class="nx">style</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Ends a dragging operation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draggingUp: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">state.stack = </span><span class="p">[]</span>

    <span class="nx">@map</span><span class="p">.</span><span class="nx">blocksEach</span> <span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">block</span><span class="p">.</span><span class="nx">setDragged</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">block</span><span class="p">.</span><span class="nx">dragged</span>
    <span class="nx">@map</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">()</span>

    <span class="nv">state.type = </span><span class="s1">&#39;normal&#39;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">css</span> <span class="s1">&#39;cursor&#39;</span><span class="p">,</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">defaultCursor</span>

    <span class="nx">@hideDraggedCanvas</span> <span class="nx">event</span>
    <span class="nx">@updateCanvasMargin</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Sets the <code>margin-top</code> of the main canvas based on the highest block stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">updateCanvasMargin: </span><span class="o">-&gt;</span>
    <span class="nv">height = </span><span class="mi">0</span>
    <span class="nx">@map</span><span class="p">.</span><span class="nx">blocksEach</span> <span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">block</span><span class="p">.</span><span class="nx">dragged</span>

      <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
      <span class="nv">height = </span><span class="nx">z</span> <span class="k">if</span> <span class="nx">z</span> <span class="o">&gt;</span> <span class="nx">height</span>
    <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">css</span>
      <span class="s1">&#39;margin-top&#39;</span><span class="o">:</span> <span class="o">-</span><span class="mi">50</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span> <span class="o">+</span> <span class="nx">height</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">textureSizeHalf</span>

  <span class="nv">normalizeCoordinates: </span><span class="nf">(handler) -&gt;</span>
    <span class="k">return</span> <span class="nf">(event) -&gt;</span>
      <span class="k">if</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">touches</span> <span class="o">and</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nv">event.pageX = </span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pageX</span>
        <span class="nv">event.pageY = </span><span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pageY</span>
      <span class="k">return</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>

  <span class="nv">updateButton: </span><span class="o">=&gt;</span>
    <span class="nv">found = </span><span class="kc">no</span>
    <span class="nx">@map</span><span class="p">.</span><span class="nx">blocksEach</span> <span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">found</span>

      <span class="nv">found = </span><span class="nx">block</span><span class="p">.</span><span class="nx">getProperty</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;crossing-hole&#39;</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.run&#39;</span><span class="p">).</span><span class="nx">toggleClass</span> <span class="s1">&#39;inactive&#39;</span><span class="p">,</span> <span class="o">!</span><span class="nx">found</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.inserter&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>

  <span class="nv">prepareRun: </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.inserter&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.popup&#39;</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;visible&#39;</span>
    <span class="nx">@updateButton</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.run&#39;</span><span class="p">).</span><span class="nx">hasClass</span> <span class="s1">&#39;inactive&#39;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#warning&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;visible&#39;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#warning .dismiss&#39;</span><span class="p">).</span><span class="nx">bind</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#warning&#39;</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;visible&#39;</span>
    <span class="k">else</span>
      <span class="nx">@map</span><span class="p">.</span><span class="nx">blocksEach</span> <span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="p">[</span><span class="nx">topType</span><span class="p">,</span> <span class="nx">topRotation</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getProperty</span> <span class="s1">&#39;top&#39;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">topType</span> <span class="o">isnt</span> <span class="s1">&#39;crossing-hole&#39;</span>

        <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>return if @map.getBlock x, y, z + 1</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">[</span><span class="nx">screenX</span><span class="p">,</span> <span class="nx">screenY</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@renderer</span><span class="p">.</span><span class="nx">renderingCoordinatesForBlock</span> <span class="nx">block</span>

        <span class="nv">$inserter = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;inserter&quot; alt=&quot;Drop marble here!&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>

        <span class="nx">$inserter</span><span class="p">.</span><span class="nx">css</span>
          <span class="nv">top: </span> <span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>  <span class="o">+</span> <span class="nx">screenY</span> <span class="o">-</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">textureSizeQuarter</span>
          <span class="nv">left: </span><span class="nx">@mainCanvas</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">screenX</span> <span class="o">+</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">textureSizeQuarter</span>

        <span class="nx">$inserter</span><span class="p">.</span><span class="nx">bind</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
          <span class="nx">x</span> <span class="o">*=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
          <span class="nx">y</span> <span class="o">*=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
          <span class="nx">z</span> <span class="o">*=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
          <span class="nx">x</span> <span class="o">+=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="err">/ 2</span>
          <span class="nx">y</span> <span class="o">+=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="err">/ 2</span>
          <span class="nx">z</span> <span class="o">+=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">*</span> <span class="mi">3</span>

          <span class="nx">@marble</span><span class="p">.</span><span class="nx">setVelocities</span>  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
          <span class="nx">@marble</span><span class="p">.</span><span class="nx">setCoordinates</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span>
          <span class="vi">@marble.isOnTrack = </span><span class="kc">no</span>
          <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.inserter&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">$inserter</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 