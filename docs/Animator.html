<!DOCTYPE html>  <html> <head>   <title>Animator.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="Animator.html">                 Animator.coffee               </a>                                           <a class="source" href="Block.html">                 Block.coffee               </a>                                           <a class="source" href="Compressor.html">                 Compressor.coffee               </a>                                           <a class="source" href="Constants.html">                 Constants.coffee               </a>                                           <a class="source" href="EventEmitter.html">                 EventEmitter.coffee               </a>                                           <a class="source" href="Game.html">                 Game.coffee               </a>                                           <a class="source" href="HitTestLayer.html">                 HitTestLayer.coffee               </a>                                           <a class="source" href="Layer.html">                 Layer.coffee               </a>                                           <a class="source" href="Main.html">                 Main.coffee               </a>                                           <a class="source" href="Map.html">                 Map.coffee               </a>                                           <a class="source" href="MapLayer.html">                 MapLayer.coffee               </a>                                           <a class="source" href="Marble.html">                 Marble.coffee               </a>                                           <a class="source" href="Palette.html">                 Palette.coffee               </a>                                           <a class="source" href="Path.html">                 Path.coffee               </a>                                           <a class="source" href="Renderer.html">                 Renderer.coffee               </a>                                           <a class="source" href="TextureStore.html">                 TextureStore.coffee               </a>                                           <a class="source" href="VisibilityLayer.html">                 VisibilityLayer.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               Animator.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Takes care of collision detection as well as positioning of the marble.
This class has a better understanding of the three-dimensional world, 
whereas the Renderer is more concerned with its 2d representation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Animator</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>
  <span class="nv">constructor: </span><span class="nf">(@map, @marble) -&gt;</span>
    <span class="nx">@map</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;didChange&#39;</span><span class="p">,</span> <span class="nx">@updatePath</span>
    <span class="nx">@map</span><span class="p">.</span><span class="nx">addListener</span> <span class="s1">&#39;didRotate&#39;</span><span class="p">,</span> <span class="nx">@handleRotation</span>

    <span class="nx">@updatePath</span><span class="p">()</span>

  <span class="nv">updatePath: </span><span class="o">=&gt;</span>
    <span class="vi">@path = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">forMap</span> <span class="nx">@map</span>

    <span class="k">if</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">isOnTrack</span>
      <span class="nv">newTargetNode = </span><span class="nx">@path</span><span class="p">.</span><span class="nx">nodeAt</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...</span>
      <span class="nv">newLastNode   = </span><span class="nx">@path</span><span class="p">.</span><span class="nx">nodeAt</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...</span>

    <span class="k">if</span> <span class="nx">newTargetNode</span> <span class="o">and</span> <span class="nx">newLastNode</span> <span class="o">and</span>
       <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span> <span class="o">is</span> <span class="nx">@blockAtWorldCoordinates</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...</span>
      <span class="vi">@marble.targetNode = </span><span class="nx">newTargetNode</span>
      <span class="vi">@marble.lastNode   = </span><span class="nx">newLastNode</span>
    <span class="k">else</span>
      <span class="vi">@marble.isOnTrack  = </span><span class="kc">no</span>
      <span class="vi">@marble.targetNode = </span><span class="kc">null</span>
      <span class="vi">@marble.lastNode   = </span><span class="kc">null</span>

  <span class="nv">handleRotation: </span><span class="p">(</span><span class="nx">clockwise</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">rotateCoordinates = </span><span class="nf">(x, y, z) -&gt;</span>
      <span class="k">if</span> <span class="nx">clockwise</span>
        <span class="p">[</span><span class="nx">y</span><span class="p">,</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">mapSize</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">mapSize</span> <span class="o">-</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span>

    <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
    <span class="nx">@marble</span><span class="p">.</span><span class="nx">setCoordinates</span> <span class="nx">rotateCoordinates</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)...</span>

    <span class="vi">@path = </span><span class="nx">Path</span><span class="p">.</span><span class="nx">forMap</span> <span class="nx">@map</span>

    <span class="k">if</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">isOnTrack</span>
      <span class="nv">newTargetNode = </span><span class="nx">@path</span><span class="p">.</span><span class="nx">nodeAt</span> <span class="nx">rotateCoordinates</span><span class="p">(</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...)...</span>
      <span class="nv">newLastNode   = </span><span class="nx">@path</span><span class="p">.</span><span class="nx">nodeAt</span> <span class="nx">rotateCoordinates</span><span class="p">(</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...)...</span>

      <span class="k">if</span> <span class="nx">newTargetNode</span> <span class="o">and</span> <span class="nx">newLastNode</span>
        <span class="vi">@marble.targetNode = </span><span class="nx">newTargetNode</span>
        <span class="vi">@marble.lastNode   = </span><span class="nx">newLastNode</span>
      <span class="k">else</span>
        <span class="vi">@marble.isOnTrack  = </span><span class="kc">no</span>
        <span class="vi">@marble.targetNode = </span><span class="kc">null</span>
        <span class="vi">@marble.lastNode   = </span><span class="kc">null</span>
    <span class="k">else</span>
      <span class="p">[</span><span class="nx">vX</span><span class="p">,</span> <span class="nx">vY</span><span class="p">,</span> <span class="nx">vZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getVelocities</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">clockwise</span>
        <span class="nx">@marble</span><span class="p">.</span><span class="nx">setVelocities</span> <span class="nx">vY</span><span class="p">,</span> <span class="o">-</span><span class="nx">vX</span><span class="p">,</span> <span class="nx">vZ</span>
      <span class="k">else</span>
        <span class="nx">@marble</span><span class="p">.</span><span class="nx">setVelocities</span> <span class="o">-</span><span class="nx">vY</span><span class="p">,</span> <span class="nx">vX</span><span class="p">,</span> <span class="nx">vZ</span>

  <span class="nv">blockAtWorldCoordinates: </span><span class="nf">(x, y, z) -&gt;</span>
    <span class="nv">bX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">x</span> <span class="err">/ (Settings.blockSize + 1))</span>
    <span class="nv">bY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">y</span> <span class="err">/ (Settings.blockSize + 1))</span>
    <span class="nv">bZ = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">z</span> <span class="err">/ (Settings.blockSize + 1))</span>

    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">bX</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span> <span class="o">and</span>
       <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">bY</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span> <span class="o">and</span>
       <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">bZ</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span>
      <span class="nx">@map</span><span class="p">.</span><span class="nx">getBlock</span><span class="p">(</span><span class="nx">bX</span><span class="p">,</span> <span class="nx">bY</span><span class="p">,</span> <span class="nx">bZ</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="kc">null</span>

  <span class="nv">applyFriction: </span><span class="nf">(velocity) -&gt;</span>
    <span class="k">if</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">velocity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">)</span>
      <span class="mi">0</span>
    <span class="k">else</span>
      <span class="nx">velocity</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">friction</span>

  <span class="nv">animate: </span><span class="o">-&gt;</span>
    <span class="p">[</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
    <span class="p">[</span><span class="nx">vX</span><span class="p">,</span> <span class="nx">vY</span><span class="p">,</span> <span class="nx">vZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getVelocities</span><span class="p">()</span>
    <span class="nv">r            = </span><span class="nx">@marble</span><span class="p">.</span><span class="nx">radius</span>

    <span class="p">[</span><span class="nx">old_mX</span><span class="p">,</span> <span class="nx">old_mY</span><span class="p">,</span> <span class="nx">old_mZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span><span class="p">]</span>

    <span class="nv">trackTest = </span><span class="nf">(x3, y3, z3, nodeA, nodeB) -&gt;</span>
      <span class="p">[</span><span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">,</span> <span class="nx">z2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nodeA</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
      <span class="p">[</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">z1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nodeB</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>

      <span class="nv">slope = </span><span class="nf">(x1, x2, y1, y2) -&gt;</span>
        <span class="p">(</span><span class="nx">y1</span> <span class="o">-</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">-</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span> <span class="c1"># if NaN</span>

      <span class="nv">isInfinite = </span><span class="nf">(x) -&gt;</span>
        <span class="o">not</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>

      <span class="nv">slopeXY = </span><span class="nx">slope</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span>
      <span class="nv">linearEquationXY = </span><span class="nf">(marbleX) -&gt;</span>
        <span class="nx">slopeXY</span> <span class="o">*</span> <span class="nx">marbleX</span> <span class="o">+</span> <span class="nx">y1</span> <span class="o">-</span> <span class="nx">slopeXY</span> <span class="o">*</span> <span class="nx">x1</span>

      <span class="nv">slopeXZ = </span><span class="nx">slope</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">z1</span><span class="p">,</span> <span class="nx">z2</span><span class="p">)</span>
      <span class="nv">linearEquationXZ = </span><span class="nf">(marbleX) -&gt;</span>
        <span class="nx">slopeXZ</span> <span class="o">*</span> <span class="nx">marbleX</span> <span class="o">+</span> <span class="nx">z1</span> <span class="o">-</span> <span class="nx">slopeXZ</span> <span class="o">*</span> <span class="nx">x1</span>

      <span class="nv">slopeYZ = </span><span class="nx">slope</span><span class="p">(</span><span class="nx">y1</span><span class="p">,</span> <span class="nx">y2</span><span class="p">,</span> <span class="nx">z1</span><span class="p">,</span> <span class="nx">z2</span><span class="p">)</span>
      <span class="nv">linearEquationYZ = </span><span class="nf">(marbleY) -&gt;</span>
        <span class="nx">slopeYZ</span> <span class="o">*</span> <span class="nx">marbleY</span> <span class="o">+</span> <span class="nx">z1</span> <span class="o">-</span> <span class="nx">slopeYZ</span> <span class="o">*</span> <span class="nx">y1</span>

      <span class="nv">xy = </span><span class="k">if</span> <span class="nx">isInfinite</span><span class="p">(</span><span class="nx">slopeXY</span><span class="p">)</span> <span class="k">then</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">y3</span><span class="p">,</span> <span class="nx">linearEquationXY</span><span class="p">(</span><span class="nx">x3</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>

      <span class="nv">xz = </span><span class="k">if</span> <span class="nx">isInfinite</span><span class="p">(</span><span class="nx">slopeXZ</span><span class="p">)</span> <span class="k">then</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">else</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">z3</span><span class="p">,</span> <span class="nx">linearEquationXZ</span><span class="p">(</span><span class="nx">x3</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

      <span class="nv">yz = </span><span class="k">if</span> <span class="nx">isInfinite</span><span class="p">(</span><span class="nx">slopeYZ</span><span class="p">)</span> <span class="k">then</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">y1</span><span class="p">,</span> <span class="nx">y3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">else</span> <span class="nx">ROUGHLY</span><span class="p">(</span><span class="nx">z3</span><span class="p">,</span> <span class="nx">linearEquationYZ</span><span class="p">(</span><span class="nx">y3</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>

      <span class="k">if</span> <span class="nx">xy</span> <span class="o">and</span> <span class="nx">xz</span> <span class="o">and</span> <span class="nx">yz</span>
        <span class="nv">x = </span><span class="k">if</span> <span class="nx">isInfinite</span><span class="p">(</span><span class="nx">slopeXY</span><span class="p">)</span> <span class="k">then</span> <span class="nx">x1</span> <span class="k">else</span> <span class="nx">x3</span>
        <span class="nv">y = </span><span class="k">if</span> <span class="nx">isInfinite</span><span class="p">(</span><span class="nx">slopeXY</span><span class="p">)</span> <span class="k">then</span> <span class="nx">y3</span> <span class="k">else</span> <span class="nx">linearEquationXY</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
        <span class="nv">z = </span><span class="k">if</span> <span class="nx">isInfinite</span><span class="p">(</span><span class="nx">slopeXZ</span><span class="p">)</span> <span class="k">then</span> <span class="nx">z3</span> <span class="k">else</span> <span class="nx">linearEquationXZ</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">and</span>
           <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">y1</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">&lt;=</span> <span class="nx">y</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">y1</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">and</span>
           <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">z1</span><span class="p">,</span> <span class="nx">z2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">&lt;=</span> <span class="nx">z</span> <span class="o">&lt;=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">z1</span><span class="p">,</span> <span class="nx">z2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
          <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="kc">null</span>
      <span class="k">else</span>
        <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Detect if marble is on tracks</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">isOnTrack</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Get the block under the marble, if any</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">block = </span><span class="nx">@blockAtWorldCoordinates</span><span class="p">(</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">block</span><span class="o">?</span> <span class="o">and</span> <span class="p">(</span><span class="nx">vZ</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">block</span> <span class="o">isnt</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span> <span class="o">and</span> <span class="nx">vZ</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">do</span> <span class="o">=&gt;</span>
          <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">nodesForBlock</span> <span class="nx">block</span>
            <span class="k">for</span> <span class="nx">neighbour</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getNeighbours</span><span class="p">()</span>
              <span class="k">if</span> <span class="nv">hitNode = </span><span class="nx">trackTest</span><span class="p">(</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">neighbour</span><span class="p">)</span>
                <span class="p">[</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hitNode</span>
                <span class="p">[</span><span class="nx">pX</span><span class="p">,</span> <span class="nx">pY</span><span class="p">,</span> <span class="nx">pZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
                <span class="p">[</span><span class="nx">nX</span><span class="p">,</span> <span class="nx">nY</span><span class="p">,</span> <span class="nx">nZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">neighbour</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>If the direction of the path is not aligned with the current
velocities, swap nodes to avoid making a U-turn.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pX</span> <span class="o">-</span> <span class="nx">nX</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pX</span> <span class="o">-</span> <span class="nx">nX</span><span class="p">)</span> <span class="o">is</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">vX</span><span class="p">)</span> <span class="o">or</span>
                   <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pY</span> <span class="o">-</span> <span class="nx">nY</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pY</span> <span class="o">-</span> <span class="nx">nY</span><span class="p">)</span> <span class="o">is</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">vY</span><span class="p">)</span> <span class="o">or</span>
                   <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pZ</span> <span class="o">-</span> <span class="nx">nZ</span><span class="p">)</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pZ</span> <span class="o">-</span> <span class="nx">nZ</span><span class="p">)</span> <span class="o">is</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">vZ</span><span class="p">)</span>
                  <span class="p">[</span><span class="nx">node</span><span class="p">,</span> <span class="nx">neighbour</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">neighbour</span><span class="p">,</span> <span class="nx">node</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We don’t want the marble to lose speed when diving into
a crossing-hole.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="p">[</span><span class="nx">topType</span><span class="p">,</span> <span class="nx">topRotation</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getProperty</span> <span class="s1">&#39;top&#39;</span>
                <span class="nx">unless</span> <span class="nx">topType</span> <span class="o">is</span> <span class="s1">&#39;crossing-hole&#39;</span>
                  <span class="nv">vX = </span><span class="nx">vX</span> <span class="o">*</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pX</span> <span class="o">-</span> <span class="nx">nX</span><span class="p">)</span>
                  <span class="nv">vY = </span><span class="nx">vY</span> <span class="o">*</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pY</span> <span class="o">-</span> <span class="nx">nY</span><span class="p">)</span>
                  <span class="nv">vZ = </span><span class="nx">vZ</span> <span class="o">*</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">pZ</span> <span class="o">-</span> <span class="nx">nZ</span><span class="p">)</span>

                <span class="nx">@marble</span><span class="p">.</span><span class="nx">setTrackSpeed</span> <span class="nx">VECTOR_LENGTH</span><span class="p">(</span><span class="nx">vX</span><span class="p">,</span> <span class="nx">vY</span><span class="p">,</span> <span class="nx">vZ</span><span class="p">)</span>

                <span class="vi">@marble.currentBlock = </span><span class="nx">block</span>

                <span class="vi">@marble.targetNode = </span><span class="nx">@path</span><span class="p">.</span><span class="nx">nodeAt</span> <span class="nx">neighbour</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...</span>
                <span class="vi">@marble.lastNode   = </span><span class="nx">@path</span><span class="p">.</span><span class="nx">nodeAt</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()...</span>

                <span class="vi">@marble.isOnTrack = </span><span class="kc">yes</span>
                <span class="k">return</span>
          <span class="vi">@marble.isOnTrack = </span><span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h1>Movement on track</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">isOnTrack</span>

      <span class="vi">@marble.currentBlock = </span><span class="nx">@blockAtWorldCoordinates</span><span class="p">(</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span><span class="p">)</span> <span class="o">or</span>
                             <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span>

      <span class="p">[</span><span class="nx">tX</span><span class="p">,</span> <span class="nx">tY</span><span class="p">,</span> <span class="nx">tZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
      <span class="p">[</span><span class="nx">lX</span><span class="p">,</span> <span class="nx">lY</span><span class="p">,</span> <span class="nx">lZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
      <span class="nv">dX = </span><span class="nx">tX</span> <span class="o">-</span> <span class="nx">mX</span>
      <span class="nv">dY = </span><span class="nx">tY</span> <span class="o">-</span> <span class="nx">mY</span>
      <span class="nv">dZ = </span><span class="nx">tZ</span> <span class="o">-</span> <span class="nx">mZ</span>

      <span class="nv">distance = </span><span class="nx">VECTOR_LENGTH</span><span class="p">(</span><span class="nx">dX</span><span class="p">,</span> <span class="nx">dY</span><span class="p">,</span> <span class="nx">dZ</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Check if the marble would collide with the next block</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">distance</span> <span class="o">&lt;</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">radius</span> <span class="o">and</span>
         <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getNeighbours</span><span class="p">().</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span>
         <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getNeighbours</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span>
        <span class="p">[</span><span class="nx">bX</span><span class="p">,</span> <span class="nx">bY</span><span class="p">,</span> <span class="nx">bZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>

        <span class="nv">nX = </span><span class="nx">bX</span> <span class="o">+</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">tX</span> <span class="o">-</span> <span class="nx">lX</span><span class="p">)</span>
        <span class="nv">nY = </span><span class="nx">bY</span> <span class="o">+</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">tY</span> <span class="o">-</span> <span class="nx">lY</span><span class="p">)</span>
        <span class="nv">nZ = </span><span class="nx">bZ</span> <span class="o">+</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">tZ</span> <span class="o">-</span> <span class="nx">lZ</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">nX</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span> <span class="o">and</span>
           <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">nY</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span> <span class="o">and</span>
           <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">nZ</span> <span class="o">&lt;</span> <span class="nx">@map</span><span class="p">.</span><span class="nx">size</span>
          <span class="nv">nextBlock = </span><span class="nx">@map</span><span class="p">.</span><span class="nx">getBlock</span> <span class="nx">nX</span><span class="p">,</span> <span class="nx">nY</span><span class="p">,</span> <span class="nx">nZ</span>

        <span class="k">if</span> <span class="nx">nextBlock</span>
          <span class="p">[</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">,</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">,</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">]</span>
          <span class="nx">@marble</span><span class="p">.</span><span class="nx">setTrackSpeed</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">()</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockDampening</span>
          <span class="p">[</span><span class="nx">tX</span><span class="p">,</span> <span class="nx">tY</span><span class="p">,</span> <span class="nx">tZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
          <span class="p">[</span><span class="nx">lX</span><span class="p">,</span> <span class="nx">lY</span><span class="p">,</span> <span class="nx">lZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
          <span class="nv">dX = </span><span class="nx">tX</span> <span class="o">-</span> <span class="nx">mX</span>
          <span class="nv">dY = </span><span class="nx">tY</span> <span class="o">-</span> <span class="nx">mY</span>
          <span class="nv">dZ = </span><span class="nx">tZ</span> <span class="o">-</span> <span class="nx">mZ</span>

          <span class="nv">distance = </span><span class="nx">VECTOR_LENGTH</span><span class="p">(</span><span class="nx">dX</span><span class="p">,</span> <span class="nx">dY</span><span class="p">,</span> <span class="nx">dZ</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Apply graviation based on slope</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">dXY   = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span> <span class="nx">dX</span> <span class="o">*</span> <span class="nx">dX</span> <span class="o">+</span> <span class="nx">dY</span> <span class="o">*</span> <span class="nx">dY</span>
      <span class="nv">slope = </span><span class="nx">unless</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">dZ</span> <span class="sr">/ dXY)) then (dZ /</span> <span class="nx">dXY</span><span class="p">)</span> <span class="k">else</span> <span class="kc">Infinity</span>
      <span class="nv">a     = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">atan</span><span class="p">(</span><span class="nx">slope</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="err">/ 2)</span>

      <span class="nv">oldSpeed = </span><span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">()</span>

      <span class="nx">@marble</span><span class="p">.</span><span class="nx">setTrackSpeed</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">()</span> <span class="o">-</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">gravity</span> <span class="o">*</span> <span class="nx">a</span>
      <span class="nx">@marble</span><span class="p">.</span><span class="nx">setTrackSpeed</span> <span class="nx">@applyFriction</span><span class="p">(</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">())</span>

      <span class="nv">newSpeed = </span><span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Flip target and last node if the marble changed direction due to
gravitational pull.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">tZ</span> <span class="o">&gt;</span> <span class="nx">mZ</span> <span class="o">&gt;</span> <span class="nx">lZ</span><span class="p">)</span> <span class="o">and</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">dZ</span> <span class="err">/ newSpeed) is -1 or</span>
         <span class="p">(</span><span class="nx">tZ</span> <span class="o">&lt;</span> <span class="nx">mZ</span> <span class="o">&lt;</span> <span class="nx">lZ</span><span class="p">)</span> <span class="o">and</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">dZ</span> <span class="err">/ newSpeed) is  1</span>
        <span class="p">[</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">,</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">,</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">]</span>
        <span class="p">[</span><span class="nx">tX</span><span class="p">,</span> <span class="nx">tY</span><span class="p">,</span> <span class="nx">tZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
        <span class="p">[</span><span class="nx">lX</span><span class="p">,</span> <span class="nx">lY</span><span class="p">,</span> <span class="nx">lZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>
        <span class="nv">dX = </span><span class="nx">tX</span> <span class="o">-</span> <span class="nx">mX</span>
        <span class="nv">dY = </span><span class="nx">tY</span> <span class="o">-</span> <span class="nx">mY</span>
        <span class="nv">dZ = </span><span class="nx">tZ</span> <span class="o">-</span> <span class="nx">mZ</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Lock the marble in position if mZ underflow.</p>

<p>This works but it’s probably very imprecise.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="nx">mZ</span> <span class="o">&lt;</span> <span class="nx">tZ</span> <span class="o">and</span> <span class="nx">SIGNUM</span><span class="p">(</span><span class="nx">dZ</span> <span class="err">/ newSpeed) is -1</span>
        <span class="nx">@marble</span><span class="p">.</span><span class="nx">setTrackSpeed</span> <span class="mi">0</span>
        <span class="nv">mZ = </span><span class="nx">lZ</span>

      <span class="k">if</span> <span class="nx">distance</span> <span class="o">&gt;</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">()</span>
        <span class="nv">s = </span><span class="nx">distance</span> <span class="err">/ @marble.getTrackSpeed()</span>

        <span class="nx">mX</span> <span class="o">+=</span> <span class="nx">dX</span> <span class="err">/ s</span>
        <span class="nx">mY</span> <span class="o">+=</span> <span class="nx">dY</span> <span class="err">/ s</span>
        <span class="nx">mZ</span> <span class="o">+=</span> <span class="nx">dZ</span> <span class="err">/ s</span>

      <span class="k">else</span>
        <span class="p">[</span><span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tX</span><span class="p">,</span> <span class="nx">tY</span><span class="p">,</span> <span class="nx">tZ</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>find next target node</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">neighbour</span> <span class="k">in</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span><span class="p">.</span><span class="nx">getNeighbours</span><span class="p">()</span>
          <span class="nx">unless</span> <span class="nx">neighbour</span> <span class="o">is</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">lastNode</span>
            <span class="nv">next = </span><span class="nx">neighbour</span>

        <span class="k">if</span> <span class="nx">next</span>
          <span class="vi">@marble.lastNode   = </span><span class="nx">@marble</span><span class="p">.</span><span class="nx">targetNode</span>
          <span class="vi">@marble.targetNode = </span><span class="nx">next</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>construct new velocity vector based on last two nodes</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">dX = </span><span class="nx">tX</span> <span class="o">-</span> <span class="nx">lX</span>
          <span class="nv">dY = </span><span class="nx">tY</span> <span class="o">-</span> <span class="nx">lY</span>
          <span class="nv">dZ = </span><span class="nx">tZ</span> <span class="o">-</span> <span class="nx">lZ</span>

          <span class="nv">s = </span><span class="nx">VECTOR_LENGTH</span><span class="p">(</span><span class="nx">dX</span><span class="p">,</span> <span class="nx">dY</span><span class="p">,</span> <span class="nx">dZ</span><span class="p">)</span> <span class="o">/</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">getTrackSpeed</span><span class="p">()</span>

          <span class="nv">new_vX = </span><span class="nx">dX</span> <span class="err">/ s</span>
          <span class="nv">new_vY = </span><span class="nx">dY</span> <span class="err">/ s</span>
          <span class="nv">new_vZ = </span><span class="nx">dZ</span> <span class="err">/ s</span>

          <span class="vi">@marble.isOnTrack = </span><span class="kc">no</span>

          <span class="p">[</span><span class="nx">vX</span><span class="p">,</span> <span class="nx">vY</span><span class="p">,</span> <span class="nx">vZ</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">new_vX</span><span class="p">,</span> <span class="nx">new_vY</span><span class="p">,</span> <span class="nx">new_vZ</span><span class="p">]</span>

          <span class="vi">@marble.targetNode = </span><span class="kc">null</span>
          <span class="vi">@marble.lastNode   = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>Normal physic</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">isOnTrack</span>
      <span class="nx">mX</span> <span class="o">+=</span> <span class="nx">vX</span>
      <span class="nx">mY</span> <span class="o">+=</span> <span class="nx">vY</span>
      <span class="nx">mZ</span> <span class="o">+=</span> <span class="nx">vZ</span>

      <span class="nx">vZ</span> <span class="o">-=</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">gravity</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Do a hit test with every block.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@map</span><span class="p">.</span><span class="nx">blocksEach</span> <span class="p">(</span><span class="nx">block</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If the marble falls off the track, it would immediately collide with
the block it just left. Therefore, we don’t consider this block for
hit testing until we hit with another block or the ground.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="k">if</span> <span class="nx">block</span> <span class="o">is</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span>

        <span class="p">[</span><span class="nx">bX</span><span class="p">,</span> <span class="nx">bY</span><span class="p">,</span> <span class="nx">bZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">block</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span>
          <span class="p">[</span><span class="nx">cX</span><span class="p">,</span> <span class="nx">cY</span><span class="p">,</span> <span class="nx">cZ</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">currentBlock</span><span class="p">.</span><span class="nx">getCoordinates</span><span class="p">()</span>

          <span class="k">if</span> <span class="nx">bX</span> <span class="o">is</span> <span class="nx">cX</span> <span class="o">and</span>
             <span class="nx">bY</span> <span class="o">is</span> <span class="nx">cY</span> <span class="o">and</span>
             <span class="nx">bZ</span> <span class="o">is</span> <span class="nx">cZ</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Check if the marble and the block potentially hit by comparing their
coordinates. If two of these match, the marble and the block are aligned
on one axis.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">xMatch = </span><span class="nx">mX</span> <span class="o">&gt;=</span> <span class="nx">bX</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">and</span>
                 <span class="nx">mX</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="nx">bX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
        <span class="nv">yMatch = </span><span class="nx">mY</span> <span class="o">&gt;=</span> <span class="nx">bY</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">and</span>
                 <span class="nx">mY</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="nx">bY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
        <span class="nv">zMatch = </span><span class="nx">mZ</span> <span class="o">&gt;=</span> <span class="nx">bZ</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">and</span>
                 <span class="nx">mZ</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="nx">bZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Hit test with block in z direction.
First check if the x and y coordinates match, i.e. if the marble
is vertically aligned with the block.
Then check if the marble is below the blocks top.
If it is, push the marble out of the block and let it bounce off.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">xMatch</span> <span class="o">and</span> <span class="nx">yMatch</span>
          <span class="k">if</span> <span class="nx">mZ</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">bZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
            <span class="nv">mZ = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">mZ</span> <span class="err">/ Settings.blockSize) * Settings.blockSize + r</span>

            <span class="nv">vZ = </span><span class="o">-</span><span class="nx">vZ</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockDampening</span>
            <span class="nv">vZ = </span><span class="mi">0</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">vZ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span>

            <span class="nv">hit = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Hit test with block in y direction
First check if the x and z coordinates match, i.e. if the marble and
the block are aligned on the y axis.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">xMatch</span> <span class="o">and</span> <span class="nx">zMatch</span>
          <span class="nv">blockLowY  = </span><span class="nx">bY</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
          <span class="nv">blockMidY  = </span><span class="nx">bY</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">+</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="err">/ 2</span>
          <span class="nv">blockHighY = </span><span class="p">(</span><span class="nx">bY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Check if the block and the marble overlap. Determine in which half
of the block the marble lies and push it out accordingly.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">mY</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">&gt;</span> <span class="nx">blockLowY</span> <span class="o">and</span> <span class="nx">mY</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">blockHighY</span>
            <span class="nv">vY = </span><span class="o">-</span><span class="nx">vY</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockDampening</span>
            <span class="k">if</span> <span class="nx">mY</span> <span class="o">&lt;=</span> <span class="nx">blockMidY</span>
              <span class="nv">mY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">mY</span> <span class="err">/ Settings.blockSize) * Settings.blockSize - r</span>
            <span class="k">else</span>
              <span class="nv">mY = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">mY</span> <span class="err">/ Settings.blockSize) * Settings.blockSize + r</span>

            <span class="nv">hit = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Hit test with block in x direction
First check if the y and z coordinates match, i.e. if the marble and
the block are aligned on the x axis.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">yMatch</span> <span class="o">and</span> <span class="nx">zMatch</span>
          <span class="nv">blockLowX  = </span><span class="nx">bX</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span>
          <span class="nv">blockMidX  = </span><span class="nx">bX</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="o">+</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span> <span class="err">/ 2</span>
          <span class="nv">blockHighX = </span><span class="p">(</span><span class="nx">bX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockSize</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Check if the block and the marble overlap. Determine in which half
of the block the marble lies and push it out accordingly.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">mX</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">&gt;</span> <span class="nx">blockLowX</span> <span class="o">and</span> <span class="nx">mX</span> <span class="o">-</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">blockHighX</span>
            <span class="nv">vX = </span><span class="o">-</span><span class="nx">vX</span> <span class="o">*</span> <span class="nx">Settings</span><span class="p">.</span><span class="nx">blockDampening</span>
            <span class="k">if</span> <span class="nx">mX</span> <span class="o">&lt;=</span> <span class="nx">blockMidX</span>
              <span class="nv">mX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">mX</span> <span class="err">/ Settings.blockSize) * Settings.blockSize - r</span>
            <span class="k">else</span>
              <span class="nv">mX = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">mX</span> <span class="err">/ Settings.blockSize) * Settings.blockSize + r</span>

            <span class="nv">hit = </span><span class="kc">yes</span>

        <span class="vi">@marble.currentBlock = </span><span class="kc">null</span> <span class="k">if</span> <span class="nx">hit</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Hit test with ground</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">mZ</span> <span class="o">-</span> <span class="nx">@marble</span><span class="p">.</span><span class="nx">radius</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="nv">mZ = </span><span class="nx">@marble</span><span class="p">.</span><span class="nx">radius</span>
        <span class="nv">vZ = </span><span class="o">-</span><span class="nx">vZ</span> <span class="o">*</span> <span class="mf">0.3</span>
        <span class="nv">vZ = </span><span class="mi">0</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">vZ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span>

        <span class="vi">@marble.currentBlock = </span><span class="kc">null</span>

      <span class="k">if</span> <span class="nx">mZ</span> <span class="o">is</span> <span class="nx">old_mZ</span>
        <span class="nv">vX = </span><span class="nx">@applyFriction</span> <span class="nx">vX</span>
        <span class="nv">vY = </span><span class="nx">@applyFriction</span> <span class="nx">vY</span>

    <span class="nx">@marble</span><span class="p">.</span><span class="nx">setCoordinates</span> <span class="nx">mX</span><span class="p">,</span> <span class="nx">mY</span><span class="p">,</span> <span class="nx">mZ</span>
    <span class="nx">@marble</span><span class="p">.</span><span class="nx">setVelocities</span>  <span class="nx">vX</span><span class="p">,</span> <span class="nx">vY</span><span class="p">,</span> <span class="nx">vZ</span>

    <span class="k">if</span> <span class="nx">old_mZ</span> <span class="o">isnt</span> <span class="nx">mZ</span> <span class="o">or</span> <span class="nx">old_mY</span> <span class="o">isnt</span> <span class="nx">mY</span> <span class="o">or</span> <span class="nx">old_mX</span> <span class="o">isnt</span> <span class="nx">mX</span>
      <span class="nx">@emit</span> <span class="s1">&#39;marble:moved&#39;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 